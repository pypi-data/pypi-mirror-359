import{r as x,u as k,a as O,j as e,P as A,B as y,T as I,b as G,s as m,S as j,I as C,c as D,d as Q,C as H,e as Z,F as S,f as F,g as W,R as z,h as X,L as T,Q as Y,H as U,i as K,k as ee}from"./vendor-DwS7OE0o.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const u of i.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function a(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=a(r);fetch(r.href,i)}})();const L=t=>t==null||t.then?!1:Object.prototype.toString.call(t)==="[object Object]";function v(){return window.__DARQ_UI_CONFIG__}function q(t){return v().base_path==="/"?t:v().embed?window.location.pathname.replace(/\/embed$/,"")+t:window.location.pathname+t}function te(t=null){let s={method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin"};return t!==null&&(s.body=JSON.stringify(t)),s}function re(){return{method:"GET",credentials:"same-origin"}}const R=async(t,s=null,a=null)=>{const n=new URLSearchParams(a),r=q(t)+(a?`?${n}`:"");try{const i=await fetch(r,te(s));if(i.ok||i.status===400)return i.json()}catch(i){throw console.log("[POST] Fetch Error :-S",i),i}},se=async(t,s=null)=>{const a=new URLSearchParams(s),n=q(t)+(s?`?${a}`:"");try{const r=await fetch(n,re());if(r.ok)return r.json()}catch(r){throw console.log("[GET] Fetch Error :-S",r),r}},_=(t,s)=>{m.error(`args "${t}" is invalid JSON array: ${s}`)},E=(t,s)=>{m.error(`kwargs "${t}" is invalid JSON: ${s}`)},ne=t=>{if(t===""||t===null)return[];if(Array.isArray(t))return t;let s=[];try{let a=JSON.parse(t);if(!Array.isArray(a))return _(t,"not an array"),null;s=a}catch(a){return _(t,a),null}return s},ae=t=>{if(t===""||t===null)return{};if(L(t))return t;let s={};try{let a=JSON.parse(t);if(!L(a))return E(t,"not a plain object"),null;s=a}catch(a){return E(t,a),null}return s},ie=({task:t,onClick:s,setArgs:a,setKwargs:n})=>e.jsxs(j,{direction:"vertical",style:{width:"390px"},children:[e.jsxs("div",{children:["Task signature: ",t.signature]}),e.jsx(C,{label:"Positional args",placeholder:"[123, true]",onChange:r=>a(r.target.value)}),e.jsx(C,{label:"Keyword args",placeholder:'{"company_id": 123, "dry_run": true}',onChange:r=>n(r.target.value)}),e.jsx(y,{onClick:s,type:"primary",children:"Run"})]}),N=Symbol("__invalid_value__"),oe=t=>t.slice(1,-1).split(",").map(a=>{const[n,r]=a.split(":").map(l=>l.trim()),i=r.split(" ")[0],u=r.split(" ")[2],h={True:"true",False:"false",None:"null"}[u]||u;return{name:n,type:i,defaultValue:h,parse:l=>{if(l==="")return h;switch(i){case"int":let o=parseInt(l);return isNaN(o)?N:o;case"float":return o=parseFloat(l),isNaN(o)?N:o;case"bool":return l==="true"||l==="True"?!0:l==="false"||l==="False"?!1:N;default:return l}}}}),le=({task:t,onClick:s,kwargs:a,setKwargs:n})=>{const r=[];let i={};try{i=JSON.parse(a)}catch{}const[u,h]=x.useState(i),f=(o,c)=>{h(d=>{if(c==="")return delete d[o.name],{...d};let p=o.parse(c);return p===N?{...d}:{...d,[o.name]:p}})};return x.useEffect(()=>{n(JSON.stringify(u))},[u]),oe(t.signature).forEach((o,c)=>{r.push(e.jsxs(j,{children:[e.jsx(D.Text,{children:`${o.name} (${o.type})`}),e.jsx(C,{label:`${o.name} (${o.type})`,placeholder:o.defaultValue,onChange:d=>f(o,d.target.value)},c)]}))}),e.jsxs(j,{direction:"vertical",style:{width:"390px"},children:[e.jsxs("div",{children:["Task signature: ",t.signature]}),r,e.jsx(C,{label:"Result keyword args",value:a,onChange:o=>n(o.target.value)}),e.jsx(y,{onClick:s,type:"primary",children:"Run"})]})},w={JSON:"json",INPUT:"input"},ce=({task:t,onClick:s,args:a,kwargs:n,setArgs:r,setKwargs:i})=>{const[u,h]=x.useState(w.JSON);return e.jsx(G,{defaultActiveKey:w.JSON,activeKey:u,onChange:f=>h(f),items:[{key:w.JSON,label:"JSON",children:e.jsx(ie,{task:t,onClick:s,setArgs:r,setKwargs:i})},{key:w.INPUT,label:"INPUT (experimental)",children:e.jsx(le,{task:t,onClick:s,kwargs:n,setKwargs:i})}]})},ue=({task:t})=>{const[s,a]=x.useState(!1),[n,r]=x.useState(""),[i,u]=x.useState(""),h=k(),{mutate:f,isPending:l}=O({mutationFn:c=>R("/api/tasks/run",c),onSuccess:(c,d)=>{c.error!==null?m.error(c.error):m.success(`Task started: "${d.task_name}"`),h.invalidateQueries({queryKey:["tasks"]})},onError:(c,d,p)=>{console.log("error",c,d,p)}}),o=()=>{const c=ne(n);if(c===null)return;const d=ae(i);d!==null&&(f({task_name:t.name,task_args:c?JSON.stringify(c):null,task_kwargs:d?JSON.stringify(d):null}),a(!1))};return e.jsx(A,{content:e.jsx(ce,{task:t,onClick:o,args:n,kwargs:i,setArgs:r,setKwargs:u}),placement:"bottomLeft",title:"Enter args",trigger:"click",open:s,onOpenChange:c=>{a(c)},children:e.jsx(y,{loading:l,type:"primary",children:"Run"})})},de=({onClick:t,setReason:s})=>e.jsxs(j,{direction:"vertical",style:{width:"390px"},children:[e.jsx(C,{label:"Reason",placeholder:"(example) Bug in task",onChange:a=>s(a.target.value)}),e.jsx(y,{onClick:t,danger:!0,type:"primary",children:"Drop"})]}),he=({taskName:t})=>{const[s,a]=x.useState(!1),[n,r]=x.useState(""),i=k(),{mutate:u,isPending:h}=O({mutationFn:l=>R("/api/tasks/droplist/add",l),onSuccess:(l,o)=>{l.error!==null?m.error(l.error):m.success(`Task added to drop list: "${o.task_name}"`),i.invalidateQueries({queryKey:["tasks"]})},onError:(l,o,c)=>{console.log("error",l,o,c)}}),f=()=>{if(n===null||n===""){m.error("Reason is required");return}u({task_name:t,reason:n}),a(!1)};return e.jsx(I,{title:"Adds task to droplist. Task can be run again only when removed from droplist manually",children:e.jsx(A,{content:e.jsx(de,{onClick:f,setReason:r}),placement:"bottomLeft",title:"Drop task reason",trigger:"click",open:s,onOpenChange:l=>{a(l)},children:e.jsx(y,{type:"primary",danger:!0,loading:h,children:"Drop"})})})},pe=({taskName:t})=>{const s=k(),{mutate:a,isPending:n}=O({mutationFn:r=>R("/api/tasks/droplist/remove",r),onSuccess:(r,i)=>{r.error!==null?m.error(r.error):m.success(`Task can be run again: "${i.task_name}"`),s.invalidateQueries({queryKey:["tasks"]})},onError:(r,i,u)=>{console.log("error",r,i,u)}});return e.jsx(I,{title:"Remove task from droplist. Task can be run again after this",children:e.jsx(y,{type:"primary",style:{background:"orange"},loading:n,onClick:()=>a({task_name:t}),children:"Undrop"})})},g={RUNNING:"running",DROPPED:"dropped"},$={[g.RUNNING]:"green",[g.DROPPED]:"red"},P="#1677ff",fe=()=>e.jsx("div",{style:{display:"flex"},children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20px",height:"20px",viewBox:"-0.5 0 25 25",fill:"none",children:[e.jsx("path",{d:"M12 21.5C17.1086 21.5 21.25 17.3586 21.25 12.25C21.25 7.14137 17.1086 3 12 3C6.89137 3 2.75 7.14137 2.75 12.25C2.75 17.3586 6.89137 21.5 12 21.5Z",stroke:P,"stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e.jsx("path",{d:"M12.9309 8.15005C12.9256 8.39231 12.825 8.62272 12.6509 8.79123C12.4767 8.95974 12.2431 9.05271 12.0008 9.05002C11.8242 9.04413 11.6533 8.98641 11.5093 8.884C11.3652 8.7816 11.2546 8.63903 11.1911 8.47415C11.1275 8.30927 11.1139 8.12932 11.152 7.95675C11.19 7.78419 11.278 7.6267 11.405 7.50381C11.532 7.38093 11.6923 7.29814 11.866 7.26578C12.0397 7.23341 12.2192 7.25289 12.3819 7.32181C12.5446 7.39072 12.6834 7.506 12.781 7.65329C12.8787 7.80057 12.9308 7.97335 12.9309 8.15005ZM11.2909 16.5301V11.1501C11.2882 11.0556 11.3046 10.9615 11.3392 10.8736C11.3738 10.7857 11.4258 10.7057 11.4922 10.6385C11.5585 10.5712 11.6378 10.518 11.7252 10.4822C11.8126 10.4464 11.9064 10.4286 12.0008 10.43C12.094 10.4299 12.1863 10.4487 12.272 10.4853C12.3577 10.5218 12.4352 10.5753 12.4997 10.6426C12.5642 10.7099 12.6143 10.7895 12.6472 10.8767C12.6801 10.9639 12.6949 11.0569 12.6908 11.1501V16.5301C12.6908 16.622 12.6727 16.713 12.6376 16.7979C12.6024 16.8828 12.5508 16.96 12.4858 17.025C12.4208 17.09 12.3437 17.1415 12.2588 17.1767C12.1738 17.2119 12.0828 17.23 11.9909 17.23C11.899 17.23 11.8079 17.2119 11.723 17.1767C11.6381 17.1415 11.5609 17.09 11.4959 17.025C11.4309 16.96 11.3793 16.8828 11.3442 16.7979C11.309 16.713 11.2909 16.622 11.2909 16.5301Z",fill:P})]})}),xe=()=>e.jsx("div",{style:{display:"flex"},children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16px",height:"16px",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("path",{d:"M15.197 3.35462C16.8703 1.67483 19.4476 1.53865 20.9536 3.05046C22.4596 4.56228 22.3239 7.14956 20.6506 8.82935L18.2268 11.2626M10.0464 14C8.54044 12.4882 8.67609 9.90087 10.3494 8.22108L12.5 6.06212",stroke:P,"stroke-width":"1.5","stroke-linecap":"round"}),e.jsx("path",{d:"M13.9536 10C15.4596 11.5118 15.3239 14.0991 13.6506 15.7789L11.2268 18.2121L8.80299 20.6454C7.12969 22.3252 4.55237 22.4613 3.0464 20.9495C1.54043 19.4377 1.67609 16.8504 3.34939 15.1706L5.77323 12.7373",stroke:P,"stroke-width":"1.5","stroke-linecap":"round"})]})}),me=()=>e.jsx("div",{style:{display:"flex"},children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16px",height:"16px",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M13.7071 1.29289C14.0976 1.68342 14.0976 2.31658 13.7071 2.70711L12.4053 4.00896C17.1877 4.22089 21 8.16524 21 13C21 17.9706 16.9706 22 12 22C7.02944 22 3 17.9706 3 13C3 12.4477 3.44772 12 4 12C4.55228 12 5 12.4477 5 13C5 16.866 8.13401 20 12 20C15.866 20 19 16.866 19 13C19 9.2774 16.0942 6.23349 12.427 6.01281L13.7071 7.29289C14.0976 7.68342 14.0976 8.31658 13.7071 8.70711C13.3166 9.09763 12.6834 9.09763 12.2929 8.70711L9.29289 5.70711C9.10536 5.51957 9 5.26522 9 5C9 4.73478 9.10536 4.48043 9.29289 4.29289L12.2929 1.29289C12.6834 0.902369 13.3166 0.902369 13.7071 1.29289Z",fill:"#ffffff"})})}),ge=()=>e.jsx("div",{children:[{status:null,description:"Task is ready to be executed"},{status:g.RUNNING,description:"Task is currently executing"},{status:g.DROPPED,description:"Task has been added to droplist and no more instances can be scheduled"}].map(t=>e.jsxs("p",{children:[e.jsx(F,{color:$[t.status],children:t.status}),t.description]},t.status))}),je=t=>t.slice(1,t.length-1).split(",").map(s=>s.trim()).join(`
`),ye=t=>t.trim().split(`
`).map(s=>s.trim()).join(`
`),Ce=({task:t})=>e.jsxs(j,{direction:"vertical",children:[e.jsxs("div",{children:["Status: ",t.status||"N/A"]}),e.jsxs("div",{children:["Queue: ",t.queue||"N/A"]}),e.jsxs("div",{children:["Signature: ",e.jsx("pre",{children:je(t.signature)})]}),e.jsxs("div",{children:["Doc: ",e.jsx("pre",{children:ye(t.docstring)})]}),t.status===g.DROPPED&&e.jsxs("div",{children:["Dropped reason: ",t.dropped_reason||"Not specified"]}),e.jsx("div",{children:e.jsx(J,{taskName:t.name})})]}),Se="${taskName}",J=({taskName:t})=>{var n;const a=(n=v().logs_url)==null?void 0:n.replaceAll(Se,t);return e.jsx("a",{target:"_blank",rel:"noreferrer",href:a,children:e.jsxs(j,{children:[e.jsx(xe,{})," Logs"]})})},ve=({tasks:t,loading:s,refetch:a})=>e.jsxs(S,{bordered:!0,loading:s,dataSource:t.map(n=>({key:n.name,...n})),expandable:{expandedRowRender:n=>e.jsx(Ce,{task:n}),columnTitle:()=>e.jsx(y,{type:"primary",shape:"circle",icon:e.jsx(me,{}),size:"small",loading:s,onClick:()=>a()})},children:[e.jsx(S.Column,{title:"Name",dataIndex:"name"}),e.jsx(S.Column,{width:100,title:e.jsxs(j,{align:"center",children:["Status",e.jsx(A,{placement:"leftTop",title:"Statuses description:",content:e.jsx(ge,{}),children:e.jsx(fe,{})})]}),dataIndex:"status",render:n=>e.jsxs(F,{color:$[n],children:[n," ",n===g.STOPPING?"...":""]})}),e.jsx(S.Column,{width:80,title:"Logs",dataIndex:"name",render:n=>e.jsx(J,{taskName:n})}),e.jsx(S.Column,{title:"Action",render:n=>e.jsx(j,{children:(()=>{let r=[];return n.status===g.RUNNING?r.push(e.jsx(he,{taskName:n.name},"drop")):n.status===g.DROPPED?r.push(e.jsx(pe,{taskName:n.name},"removeTaskFromDroplist")):n.status===null&&r.push(e.jsx(ue,{task:n},"run")),r})()})})]}),we=(t,s)=>s?t.filter(a=>a.name.includes(s||"")):t,Ne=()=>{const[t,s]=W();if(!v().embed)return[t,s];const a=new URLSearchParams(window.parent.location.search);return[a,r=>{const i=r(a);window.parent.location.search=i.toString()}]},B=()=>{const[t,s]=Ne(),a=t.get("search"),[n,r]=x.useState(a),{isPending:i,isError:u,data:h,error:f,refetch:l}=Q({queryKey:["tasks"],queryFn:()=>se("/api/tasks")}),o=i;u&&console.error("Error while fetching tasks",f);const c=we((h==null?void 0:h.tasks)||[],n),d=c.filter(p=>p.status===g.RUNNING).length;return e.jsxs(e.Fragment,{children:[e.jsx(H,{children:e.jsxs(j,{direction:"vertical",children:[e.jsx(Z,{loading:o,title:"Tasks running",value:d,valueStyle:{color:"#3f8600"}}),e.jsx(C.Search,{placeholder:"Enter task name ...",allowClear:!0,onChange:p=>{r(p.target.value)},onSearch:(p,Le,V)=>{s(b=>(V.source==="clear"?b.delete("search"):b.set("search",p),b)),r(p)},defaultValue:a,style:{width:"500px"}})]})}),e.jsx(ve,{data:h,tasks:c,loading:o,refetch:l})]})},Te=()=>e.jsx(z,{children:e.jsx(X,{index:!0,element:e.jsx(B,{})})}),{Header:Pe,Content:be}=T,ke=()=>e.jsxs(T,{style:{minHeight:"100vh"},children:[e.jsx(Pe,{style:{padding:"0 24px"},children:e.jsx(D.Title,{style:{color:"#fff",fontSize:"24px",fontFamily:"helvetica"},children:"Darq UI"})}),e.jsx(T,{children:e.jsx(be,{style:{padding:24},children:e.jsx(Te,{})})})]}),Oe=()=>e.jsx(T,{style:{minHeight:"100vh"},children:e.jsx(B,{})}),M=new Y({defaultOptions:{queries:{refetchOnWindowFocus:!1}}});function Ae(){return e.jsx(U,{children:e.jsx(K,{client:M,children:e.jsx(ke,{})})})}function Re(){return e.jsx(U,{children:e.jsx(K,{client:M,children:e.jsx(Oe,{})})})}ee(document.getElementById("root")).render(e.jsx(x.StrictMode,{children:v().embed?e.jsx(Re,{}):e.jsx(Ae,{})}));
