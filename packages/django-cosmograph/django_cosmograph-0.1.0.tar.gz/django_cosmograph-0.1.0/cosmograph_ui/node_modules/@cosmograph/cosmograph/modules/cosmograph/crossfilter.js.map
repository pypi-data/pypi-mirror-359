{"version":3,"file":"crossfilter.js","sources":["../../../src/modules/cosmograph/crossfilter.ts"],"sourcesContent":["import crossfilter from 'crossfilter2'\n\ntype OnFilterCallback = () => void\ntype OnDataAddedCallback = () => void\ntype OnDataRemovedCallback = () => void\n\nexport class Filter<Record> {\n  private _crossfilter: crossfilter.Crossfilter<Record>\n  private _dimension: crossfilter.Dimension<Record, string | number> | undefined\n  private _selfRemove: () => void\n  private _syncUp: (() => void) | undefined\n  public onFiltered: OnFilterCallback | undefined\n  public onDataAdded: OnDataAddedCallback | undefined\n  public onDataRemoved: OnDataRemovedCallback | undefined\n\n  constructor (crossfilter: crossfilter.Crossfilter<Record>, selfRemove: () => void, syncUp?: () => void) {\n    this._crossfilter = crossfilter\n    this._selfRemove = selfRemove\n    this._syncUp = syncUp\n  }\n\n  public setAccessor (selector: crossfilter.OrderedValueSelector<Record, string | string[] | number | number[]>): void {\n    const { _crossfilter } = this\n    this.dispose()\n    this._dimension = _crossfilter.dimension(selector)\n  }\n\n  public applyFilter (filterValue: (d: unknown) => boolean): void {\n    this._dimension?.filter(filterValue)\n    this._syncUp?.()\n  }\n\n  public clear (): void {\n    this._dimension?.filterAll()\n    this._syncUp?.()\n  }\n\n  public getAllValues (): crossfilter.NaturallyOrderedValue[] | undefined {\n    const { _crossfilter, _dimension } = this\n    if (!_dimension) return undefined\n    return _crossfilter.all().map(_dimension.accessor)\n  }\n\n  public getFilteredValues (): crossfilter.NaturallyOrderedValue[] | undefined {\n    const { _crossfilter, _dimension } = this\n    if (!_dimension) return undefined\n    return _crossfilter.allFiltered().map(_dimension.accessor)\n  }\n\n  public getFilteredRecords (): Record[] {\n    // Crossfilter declaration file does not have any arguments for `allFiltered` function,\n    // but it is present in the code - https://github.com/crossfilter/crossfilter/wiki/API-Reference#crossfilter_isElementFiltered\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n    // @ts-ignore\n    return this._crossfilter.allFiltered([this._dimension])\n  }\n\n  public isActive (): boolean {\n    return this._dimension?.hasCurrentFilter() || false\n  }\n\n  public dispose (): void {\n    this._dimension?.dispose()\n  }\n\n  public remove (): void {\n    this.dispose()\n    this._selfRemove()\n  }\n}\n\nexport class Crossfilter<Record> {\n  private _crossfilter = crossfilter<Record>()\n  private _records: Record[] | undefined\n  private _filters = new Set<Filter<Record>>()\n  private _syncUpFunction: () => void\n  public onFiltered: OnFilterCallback | undefined\n  public onDataAdded: OnDataAddedCallback | undefined\n  public onDataRemoved: OnDataRemovedCallback | undefined\n\n  constructor (syncUpFunction: () => void) {\n    this._syncUpFunction = syncUpFunction\n    this._crossfilter.onChange(eventType => {\n      switch (eventType) {\n        case 'filtered': {\n          this.onFiltered?.()\n          this._filters.forEach(filter => { filter.onFiltered?.() })\n          break\n        }\n        case 'dataAdded': {\n          this.onDataAdded?.()\n          this._filters.forEach(filter => { filter.onDataAdded?.() })\n          break\n        }\n        case 'dataRemoved':{\n          this.onDataRemoved?.()\n          this._filters.forEach(filter => { filter.onDataRemoved?.() })\n          break\n        }\n      }\n    })\n  }\n\n  public addRecords (records: Record[]): void {\n    const { _crossfilter } = this\n    this._records = records\n    _crossfilter.remove()\n    _crossfilter.add(records)\n  }\n\n  public getFilteredRecords (ignoreFilter?: Filter<Record>): Record[] {\n    const { _crossfilter } = this\n    return ignoreFilter?.getFilteredRecords() || _crossfilter.allFiltered()\n  }\n\n  public addFilter (runSyncOnApply = true): Filter<Record> {\n    const filter = new Filter<Record>(this._crossfilter, () => { this._filters.delete(filter) }, runSyncOnApply ? this._syncUpFunction : undefined)\n    this._filters.add(filter)\n    return filter\n  }\n\n  public clearFilters (): void {\n    this._filters.forEach(filter => {\n      filter.clear()\n    })\n  }\n\n  public isAnyFiltersActive (exceptFilter?: Filter<Record>): boolean {\n    for (const filter of this._filters.values()) {\n      if (filter !== exceptFilter && filter.isActive()) return true\n    }\n    return false\n  }\n\n  public getAllRecords (): Record[] | undefined {\n    return this._records\n  }\n}\n"],"names":["Filter","constructor","crossfilter","selfRemove","syncUp","this","_crossfilter","_selfRemove","_syncUp","setAccessor","selector","dispose","_dimension","dimension","applyFilter","filterValue","_a","filter","_b","call","clear","filterAll","getAllValues","all","map","accessor","getFilteredValues","allFiltered","getFilteredRecords","isActive","hasCurrentFilter","remove","Crossfilter","syncUpFunction","_filters","Set","_syncUpFunction","onChange","eventType","onFiltered","forEach","onDataAdded","_c","onDataRemoved","addRecords","records","_records","add","ignoreFilter","addFilter","runSyncOnApply","delete","undefined","clearFilters","isAnyFiltersActive","exceptFilter","values","getAllRecords"],"mappings":"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"}