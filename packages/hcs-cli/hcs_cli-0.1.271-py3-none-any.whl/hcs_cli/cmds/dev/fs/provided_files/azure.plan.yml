deploymentId: aquilo
var:
  orgId: ${profile.csp.orgId}
  region: ${env.REGION}
  provider:
    id: ${env.PRIMARY_PROVIDER_ID?}
    subscriptionId: ${env.SUBSCRIPTION_ID?}
    directoryId: ${env.DIRECTORY_ID?}
    applicationId: ${env.APPLICATION_ID?}
    applicationKey: ${env.APPLICATION_KEY?}
  infra:
    resourceGroup: ${env.INFRA_RESOURCE_GROUP}
    vnet: ${env.INFRA_VNET}
    subnet: ${env.INFRA_SUBNET}
    subnetAddressSpace: ${env.INFRA_SUBNET_ADDRESS_SPACE}
  desktop:
    resourceGroup: ${env.DESKTOP_RESOURCE_GROUP}
    vnet: ${env.DESKTOP_VNET}
  uag:
    fqdn: ${env.FQDN}
    vmSubnet: ${env.VM_SUBNET}
    vmSubnetAddressSpace: ${env.VM_SUBNET_ADDRESS_SPACE}
    managementSubnet: ${env.MANAGEMENT_SUBNET}
    managementSubnetAddressSpace: ${env.MANAGEMENT_SUBNET_ADDRESS_SPACE}
    dmzSubnet: ${env.DMZ_SUBNET}
    dmzSubnetAddressSpace: ${env.DMZ_SUBNET_ADDRESS_SPACE}
  image:
    subnet: ${env.IMAGE_SUBNET}
    username: ${env.IMAGE_USERNAME}
    password: ${env.IMAGE_PASSWORD}



# ----------------------------------
# Blueprint: v1/infra-green.blueprint.yml
default:
  name: ${deploymentId}
resource:
  myProvider:
    kind: hcs/provider
    conditions:
      create_new: ${var.provider.applicationId}
    data:
      orgId: ${var.orgId}
      providerLabel: azure
      name: ${default.name}
      edgeGatewayNeeded: true
      providerDetails:
        method: ByAppRegistration
        data:
          subscriptionId: ${var.provider.subscriptionId}
          directoryId: ${var.provider.directoryId}
          applicationId: ${var.provider.applicationId}
          applicationKey: ${var.provider.applicationKey}
          region: ${var.region}
          environment: AZURE
  mySite:
    kind: hcs/site
    data:
      orgId: ${var.orgId}
      name: ${default.name}
      description: Debug info the in-use provider
  myAD:
    kind: hcs/ad
    data:
      orgId: ${var.orgId}
      name: ${default.name}
      description: AD generated by hcs plan
      defaultOU: ${env.AD_DEFAULT_OU}
      dnsDomainName: ${env.AD_DNS_DOMAIN}
      netBIOSName: ${env.AD_NETBIOS_NAME}
      joinAccounts:
        primary:
          username: ${env.JOIN_PRIMARY_ACCOUNT_USERNAME}
          password: ${env.JOIN_PRIMARY_ACCOUNT_PASSWORD}
        auxiliary:
          username: ${env.JOIN_AUXILIARY_ACCOUNT_USERNAME}
          password: ${env.JOIN_AUXILIARY_ACCOUNT_PASSWORD}
      bindAccounts:
        primary:
          username: ${env.BIND_PRIMARY_ACCOUNT_USERNAME}
          password: ${env.BIND_PRIMARY_ACCOUNT_PASSWORD}
        auxiliary:
          username: ${env.BIND_AUXILIARY_ACCOUNT_USERNAME}
          password: ${env.BIND_AUXILIARY_ACCOUNT_PASSWORD}
      primaryDNS: null
      secondaryDNS: null
  myEdge:
    kind: hcs/edge
    data:
      orgId: ${var.orgId}
      providerInstanceId: ${myProvider.id}
      name: ${default.name}
      description: Edge generated by hcs plan
      siteId: ${mySite.id}
      providerLabel: azure
      infrastructure:
        managementNetwork:
          kind: subnets
          id: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}/subnets/${var.infra.subnet}
          data:
            parent: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}
            name: ${var.infra.subnet}
            cidr: ${var.infra.subnetAddressSpace}
  myUAG:
    after:
      - myEdge
    kind: hcs/uag
    data:
      orgId: ${var.orgId}
      name: ${default.name}
      description: UAG generated by hcs plan
      providerInstanceId: ${myProvider.id}
      fqdn: ${var.uag.fqdn}
      numberOfGateways: 2
      lbLoadDistributionType: SOURCE_IP_AFFINITY
      type: EXTERNAL
      infrastructure:
        managementNetwork:
          kind: subnets
          id: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}/subnets/${var.uag.managementSubnet}
          data:
            parent: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}
            name: ${var.uag.managementSubnet}
            cidr: ${var.uag.managementSubnetAddressSpace}
        dmzNetwork:
          kind: subnets
          id: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}/subnets/${var.uag.dmzSubnet}
          data:
            parent: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}
            name: ${var.uag.dmzSubnet}
            cidr: ${var.uag.dmzSubnetAddressSpace}
        desktopNetwork:
          kind: subnets
          id: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.desktop.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.desktop.vnet}/subnets/${var.uag.vmSubnet}
          data:
            parent: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.desktop.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.desktop.vnet}
            name: ${var.uag.vmSubnet}
            cidr: ${var.uag.vmSubnetAddressSpace}
        vmSkus:
          kind: vmSkus
          id: Standard_A4_v2
          data:
            capabilities:
              MemoryPreservingMaintenanceSupported: true
              vCPUsAvailable: 4
              OSVhdSizeMB: 1047552
              CombinedTempDiskAndCachedReadBytesPerSecond: 83886080
              CombinedTempDiskAndCachedWriteBytesPerSecond: 41943040
              EncryptionAtHostSupported: false
              UncachedDiskBytesPerSecond: 96000000
              CombinedTempDiskAndCachedIOPS: 4000
              RdmaEnabled: false
              MemoryGB: 8
              PremiumIO: false
              CapacityReservationSupported: true
              CpuArchitectureType: x64
              AcceleratedNetworkingEnabled: false
              LowPriorityCapable: true
              HyperVGenerations: ''
              VMDeploymentTypes: PaaS,IaaS
              UncachedDiskIOPS: 6400
              EphemeralOSDiskSupported: false
              MaxDataDiskCount: 8
              MaxResourceVolumeMB: 40960
              vCPUsPerCore: 1
              MaxNetworkInterfaces: 4
              ACUs: 100
              vCPUs: 4
              SupportsV1: true
              SupportsV2: false
            uagAllowed: true
            tier: Standard
            templateRecommended: false
            series: Av2
            name: A4_v2 (4 CPUs, 8GiB Memory)
            templateBlocked: false
            edgeAllowed: false
            family: standardAv2Family
            gpuType: NONE
      sslCertificate:
        data:
          certificate: |
            -----BEGIN CERTIFICATE-----
            MIIC2DCCAcCgAwIBAgIJAMWJXNXU+fD5MA0GCSqGSIb3DQEBCwUAMBoxCzAJBgNV
            BAYTAlVTMQswCQYDVQQIDAJDQTAeFw0yNDA5MTYwNDQ5NDFaFw0yNjA5MTYwNDQ5
            NDFaMBoxCzAJBgNVBAYTAlVTMQswCQYDVQQIDAJDQTCCASIwDQYJKoZIhvcNAQEB
            BQADggEPADCCAQoCggEBANTfGlpoSreVvoOlHOoe/SdZzEUIM4EwDH4BURCOYjin
            QCh/trlgXOKSXOz+p2yrMddKKX7VW0dzg/B+g2rxyjYItnORcHaexUBM/IJC/u8Z
            3gTIu3KmQZabXfWHfdFAm8XOVQHVY/dpnOAb0szjBXYl3c7Gz/6SJeGSrm+Q7HMJ
            M40CgYpYFSde2ULIby6ruGP+Z2xRdBVZsK7QefDywtFOzKJLlvOZBVXHKUAWYVDG
            twBp3zeBVYxeen7jWY2IcYCB/9wJrlChVwU7mKFhzbJr2eehPJnKCLljc5j7jANa
            VRJg9DKAD41dJBScJ25FB93vul5R6CwPDm5R0QfheDkCAwEAAaMhMB8wHQYDVR0O
            BBYEFBI/JhBCdLrbegYpDc9zb2OWWohKMA0GCSqGSIb3DQEBCwUAA4IBAQAfqo6S
            rWMne9vuH4E/9pAZkYvTd5cXUCL3gfItHzhDi7sGXCqgp/sC4HOdALbrfJkzgAmc
            q3JJAOTC3nanbwVYlUo8DDiTcRH8MLnKB6qR2HpcFxbjdTKxFrpIQtcxh8hIU4Gk
            /BnyrYO/uuqAEXX70onP2e8fST8JUqbSGvuJ3enjd+4SARsMRIsKq8p2EQLZRQYC
            nBDcnGtzQ+ZGByhJh5pflg1CqTNV6uDOWOOywtNY4hA6E5dI7SdjeeLxJNbHfbPj
            gd8doB807z2GC5iocHFwboEkHsmC7yR9oHh5hcHYdBvqtJgc+gQsOz7gkLWL7TCL
            lS6gRq3JWJgzpDQS
            -----END CERTIFICATE-----
            -----BEGIN PRIVATE KEY-----
            MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDU3xpaaEq3lb6D
            pRzqHv0nWcxFCDOBMAx+AVEQjmI4p0Aof7a5YFziklzs/qdsqzHXSil+1VtHc4Pw
            foNq8co2CLZzkXB2nsVATPyCQv7vGd4EyLtypkGWm131h33RQJvFzlUB1WP3aZzg
            G9LM4wV2Jd3Oxs/+kiXhkq5vkOxzCTONAoGKWBUnXtlCyG8uq7hj/mdsUXQVWbCu
            0Hnw8sLRTsyiS5bzmQVVxylAFmFQxrcAad83gVWMXnp+41mNiHGAgf/cCa5QoVcF
            O5ihYc2ya9nnoTyZygi5Y3OY+4wDWlUSYPQygA+NXSQUnCduRQfd77peUegsDw5u
            UdEH4Xg5AgMBAAECggEBAMAIF6zxIl4k/v2hSMlHdVY3Ytfvgw8Kumo9Y9TMrXyw
            HGesdrkaXhCiuqOtQnn8ofS2WWKqtDJr2d1tM76ZKrK9/2GYFV1c81KDYNNd/r7R
            lgC42KifpNFpjUR+mxjW8O9rqDIEP68lHjjpwKvGLNodZNAxd9cOHpA0k5nfof5O
            7AlsMqimjfF70nCf6iP7l/sd8TRYVsL3jRUo8Rn7FvqNcdM7p1KwQga4cfR1xGqW
            QJvcdDW8urBtrA2qmjLSBSeMqh5Nzpo/2yaItx1Uka3HRMYZUfFZQmYwE4jSIy57
            UOML3SuSjcXd07fzUvganb0lpredK+Tc7XL20Ilw2QECgYEA9HrXkM6rJI+1yxJk
            v4iNH5T3lZSBkGxgWx1lcoN0Wu0JBxZ56yJdY9UiTHc+67ehD0PC+vqjsWfQSSyW
            fTCIIbLKLJAqbl4ROSwcKf+MJBPbYT4U87SJiqwq1XVzkbj01jODg5NLUySMB3YZ
            5D1hATM+PlDx8VWy8zKqhIG7mdkCgYEA3ub4OLVvWIprgNtbjiJlBZhZy8rpC/ac
            gVr0Nbm6jjKEAsv/a62om5iqVTASjqEHgP2cohuLwLUyVgsqs4HGnPw2Dtb6GMpH
            LJ3OJ0AO1Te6nSROVXMtx130MLjMxSCUGVCqXqijXlyz9GXXMYW16CP8h7mdJFwM
            U8RugMzcdWECgYAt0Cs/FotZoZiGgl7gyXzwkyDGJfsVjkmMKXkOOXX/Z/XOHzcf
            ieQIRjNUMvBWiaWjz6XlFDzCjNqqK7HTqdmIvxFFwopA/l2p4gsxD5M6W4I7ub+B
            X656jwLD12udvhQbY7HcYSi3XtzitQ3rCFl6ORkL4m1ENTQAgNkVVZ5LGQKBgALH
            XFbQpDe1Wgu8MFMASMQeFxh8ShV1GJRgPuUgkJvPM2gZhPChtJVj/NOdCs4uYbqQ
            7s/yifZ4C82YzAp61rAEUOQ0d9+xPdvnh7djjAvKaxAkcLmN+wceO7oTw7G9azs5
            jzYo4gh+HVwxnNIoOZFQSYijnrriTuEIdNw0MZdhAoGASCNPSp6XEX4984ugtxTf
            mAxw6J6ByZtw90TARsnScZKwksk9ZDKbSWlM6TOugfSMBocRW5jsURni0bIcLV0B
            UR6RWezvMNXcqfz7Z3BNfnV0+pphZQzJKuDbw1X7zEajtnTIbzbE6AKMxvNnXKzz
            J1/sLXvki3toEOdVa9pF1NY=
            -----END PRIVATE KEY-----
        type: PEM
  myImageMultiSession:
    kind: hcs/image
    data:
      import:
        orgId: ${var.orgId}
        providerInstanceId: ${myProvider.id}
        streamName: ${default.name}-multi
        streamDescription: Multi session image generated by hcs plan
        providerLabel: AZURE
        versionSource: 0.0
        versionType: MAJOR
        gpuType: NONE
        sourceStreamType: AZURE_MARKET_PLACE
        os: Windows 10 Enterprise multi-session, 20H2
        osType: WINDOWS
        markers:
        - name: default
        assetDetails:
          data:
            generationType: V1
            licenseType: Windows_Client
            offer: windows-10
            publisher: microsoftwindowsdesktop
            sku: 20h2-evd
            vmSize: Standard_DS2_v2
            subNet: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}/subnets/${var.image.subnet}
            vNet: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}
          vmInfo:
            username: ${var.image.username}
            password: ${var.image.password}
          options:
            createPublicIp: false
          type: AZURE_VM_IN_RG
      publish:
        orgId: ${var.orgId}
        versionName: 1.0.0
        providerLabel: AZURE
  myImageSingleSession:
    kind: hcs/image
    data:
      import:
        orgId: ${var.orgId}
        providerInstanceId: ${myProvider.id}
        streamName: ${default.name}-single
        streamDescription: Single session image generated by hcs plan
        providerLabel: AZURE
        versionSource: 0.0
        versionType: MAJOR
        gpuType: NONE
        sourceStreamType: AZURE_MARKET_PLACE
        os: Windows 10 Enterprise, 22H2
        osType: WINDOWS
        markers:
        - name: default
        assetDetails:
          data:
            generationType: V1
            licenseType: Windows_Client
            offer: windows-10
            publisher: microsoftwindowsdesktop
            sku: win10-22h2-ent
            vmSize: Standard_DS2_v2
            subNet: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}/subnets/${var.image.subnet}
            vNet: /subscriptions/${var.provider.subscriptionId}/resourceGroups/${var.infra.resourceGroup}/providers/Microsoft.Network/virtualNetworks/${var.infra.vnet}
          vmInfo:
            username: ${var.image.username}
            password: ${var.image.password}
          options:
            createPublicIp: false
          type: AZURE_VM_IN_RG
      publish:
        orgId: ${var.orgId}
        versionName: 1.0.0
        providerLabel: AZURE

