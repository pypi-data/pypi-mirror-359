var S=class{constructor(){this.elements=[],this.connections=new Map}validateAddElement(t){if(this.elements.some(e=>e.id===t.id))throw new Error(`Element with id ${t.id} is already in the circuit.`)}validateConnection(t,e){let i=new Set(t.nodes.map(r=>`${r.x},${r.y}`));for(let r of e.nodes){let a=`${r.x},${r.y}`;if(i.has(a)){if((this.connections.get(a)||[]).some(m=>m!==t&&m!==e))throw new Error(`Node at position (${r.x}, ${r.y}) is already connected and cannot accept additional connections.`);this.connections.has(a)||this.connections.set(a,[]),this.connections.get(a).push(t,e)}}let n=t.type==="wire"?t:e.type==="wire"?e:null,s=t.type==="wire"?e.nodes[0]:t.nodes[0];if(n&&s)for(let r=0;r<n.nodes.length-1;r++){let a=n.nodes[r],c=n.nodes[r+1];if(this.isNodeOnWireSegment(s,a,c)){let d=`${s.x},${s.y}`;if((this.connections.get(d)||[]).some(g=>g===s))throw new Error(`Node at position (${s.x}, ${s.y}) is already connected and cannot accept additional connections.`);this.connections.has(d)||this.connections.set(d,[]),this.connections.get(d).push(n,s);return}}}isNodeOnWireSegment(t,e,i){if(t.x<Math.min(e.x,i.x)||t.x>Math.max(e.x,i.x)||t.y<Math.min(e.y,i.y)||t.y>Math.max(e.y,i.y))return!1;let n=(i.y-e.y)*(t.x-e.x)-(t.y-e.y)*(i.x-e.x);return!(Math.abs(n)>1e-10)}getSerializedElements(){return this.elements.map(t=>({id:t.id,type:t.type,nodes:t.nodes.map(e=>({x:e.x,y:e.y})),properties:t.properties.values}))}};var v=class{constructor(){this.events={}}on(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push(e)}off(t,e){this.events[t]&&(this.events[t]=this.events[t].filter(i=>i!==e))}emit(t,e){this.events[t]&&this.events[t].forEach(i=>i(e))}};var b=class o{constructor(t){if(!o.isValid(t))throw new Error("Invalid label: Must be non-empty and less than 50 characters.");this.value=t}static isValid(t){return typeof t=="string"&&t.trim().length>0&&t.length<=50}toString(){return this.value}equals(t){return t instanceof o&&this.value===t.value}};var h=class{constructor(t,e){if(t<0||e<0)throw new Error("Position coordinates must be non-negative.");this.x=t,this.y=e}equals(t){return this.x===t.x&&this.y===t.y}};var l=class{constructor(t={}){if(typeof t!="object"||t===null)throw new Error("Properties must be a non-null object.");Object.entries(t).forEach(([e,i])=>{if(!this.isValidValue(i))throw new Error(`Invalid value for property "${e}". Must be a float, "variable", or undefined.`)}),this.values=t}isValidValue(t){return typeof t=="number"||t==="variable"||t===void 0}updateProperty(t,e){if(!this.isValidValue(e))throw new Error(`Invalid value for property "${t}". Must be a float, "variable", or "undefined".`);this.values[t]=e}describe(){return Object.entries(this.values).map(([t,e])=>`${t}: ${e}`).join(", ")}};var y=class o{constructor(t,e,i=null,n){if(new.target===o)throw new Error("Cannot instantiate abstract class Element directly.");if(!Array.isArray(e)||!e.every(s=>s instanceof h))throw new Error("Nodes must be an array of Position instances.");if(i!==null&&!(i instanceof b))throw new Error("Label must be an instance of Label or null.");if(!(n instanceof l))throw new Error("Properties must be an instance of Properties.");this.id=t,this.nodes=e,this.label=i,this.type=null,this.properties=n}describe(){let t=this.label?`, label: "${this.label}"`:"",e=this.nodes.map(i=>`(${i.x}, ${i.y})`).join(", ");return`${this.type} (${this.id}): nodes: [${e}]${t}, properties: ${this.properties.describe()}`}};var z=0,w=(o="")=>(z+=1,`${o}${z}`);var W=class o{constructor(){return o.instance||(this._registry={},o.instance=this),o.instance}register(t,e){if(this._registry[t])throw new Error(`Element type "${t}" is already registered.`);this._registry[t]=e}get(t){return this._registry[t]}getTypes(){return Object.keys(this._registry)}},u=new W;Object.freeze(u);var C=class{constructor(){this.registry=new Map}register(t,e){this.registry.set(t,e)}create(t,e){let i=this.registry.get(t);if(!i)throw new Error(`No renderer registered for element type: "${t}"`);return new i(e)}};var X=class{constructor(t){if(t<=0)throw new Error("Resistance must be greater than zero.");this.value=t}equals(t){return this.value===t.value}};var T=class extends y{constructor(t,e,i=null,n=new l({resistance:void 0})){if(e.length!==2)throw new Error("A Resistor must have exactly two nodes.");if(!(n instanceof l))throw new Error("Properties must be an instance of Properties.");let s=n.values.resistance;if(s!==void 0){if(typeof s!="number")throw new Error("Resistance must be a number or undefined.");new X(s)}super(t,e,i,n),this.type="resistor"}};var A=class extends y{constructor(t,e,i=null,n=new l){super(t,e,i,n),this.type="wire"}};var x=class{constructor(t){this.context=t,this.showAlignmentGuide=!1,this.alignmentGuideColor="red",this.alignmentGuideSize=4}renderTerminal(t){this.context.fillStyle="black",this.context.beginPath(),this.context.arc(t.x,t.y,2,0,Math.PI*2),this.context.fill(),this.showAlignmentGuide&&this.renderAlignmentGuide(t)}renderLabel(t,e,i){this.context.fillStyle="white",this.context.font="12px Arial",this.context.textAlign="center",this.context.fillText(t,e,i)}renderAlignmentGuide(t){let e=this.context,i=this.alignmentGuideSize;e.save(),e.strokeStyle=this.alignmentGuideColor,e.lineWidth=1,e.beginPath(),e.moveTo(t.x-i,t.y),e.lineTo(t.x+i,t.y),e.moveTo(t.x,t.y-i),e.lineTo(t.x,t.y+i),e.stroke(),e.restore()}renderElement(t){throw new Error("renderElement() must be implemented in derived classes.")}};var B="data:image/png;base64,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";var G="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAACWCAYAAABkW7XSAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAuIwAALiMBeKU/dgAAADh0RVh0U29mdHdhcmUAbWF0cGxvdGxpYiB2ZXJzaW9uMy4xLjAsIGh0dHA6Ly9tYXRwbG90bGliLm9yZy+17YcXAAACVklEQVR4nO3dwWnEMBBAUW1wLzok/VeSHFSN0kHwQhbxk/ca8PgwHwkMfuy9B0DB2+kBAO4SLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8i4Tg/Ac+acL/9V91rr8epn3PXf3pefOWEBGYIFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpBxzTnfTw8BJ9mBjmuM8Xl6CDjMDkS4EgIZggVkCBaQIVhAhmABGYIFZAgWkHGNMT5OD8FTfDP0++xAxLXW+jo9BPfNOU+P8OfYgQ5XQiBDsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIOOx9z49A8AtTlhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkfANboxp4RlTMaQAAAABJRU5ErkJggg==";function U(o){if(o==="R.png")return B;if(o==="C.png")return G;throw new Error(`Unknown type: ${o}`)}var D=class extends x{constructor(t){super(t),this.image=new Image,this.image.src=U("R.png"),this.imageLoaded=!1,this.image.onload=()=>{this.imageLoaded=!0},this.SCALED_WIDTH=50,this.SCALED_HEIGHT=20}renderElement(t){if(!this.imageLoaded)return;let[e,i]=t.nodes,n=(e.x+i.x)/2,s=(e.y+i.y)/2;this.renderTerminal(e),this.renderTerminal(i),this.context.drawImage(this.image,n-this.SCALED_WIDTH/2,s-this.SCALED_HEIGHT/2,this.SCALED_WIDTH,this.SCALED_HEIGHT),t.label&&this.renderLabel(t.label.text,n,s+25)}registerClickHandler(t,e){t.addEventListener("mouseup",i=>{let n=t.getBoundingClientRect(),s=i.clientX-n.left,r=i.clientY-n.top;console.log(`\u{1F4CC} Click detected at: ${s}, ${r}`);let a=[new h(s-this.SCALED_WIDTH/2,r),new h(s+this.SCALED_WIDTH/2,r)];console.log("\u{1F4CC} Calculated node positions:",a),e?(e.execute(a),console.log(`AddElementCommand executed for ${e.elementType}`)):console.warn("\u26A0\uFE0F No command provided for adding the element.")},{once:!0})}};var I=class extends x{renderElement(t){let[e,i]=t.nodes;this.renderTerminal(e),this.renderTerminal(i),this.context.strokeStyle="black",this.context.lineWidth=1,this.context.beginPath(),this.context.moveTo(e.x,e.y),this.context.lineTo(i.x,i.y),this.context.stroke()}};var k=class o{constructor(){return o.instance?this._registry=o.instance._registry:(this._registry=new Map,o.instance=this),o.instance}register(t,e){if(this._registry.has(t))throw new Error(`Command "${t}" is already registered.`);this._registry.set(t,e)}get(t,...e){return this._registry.has(t)?this._registry.get(t)(...e):(console.warn(`Command "${t}" not found.`),null)}getTypes(){return[...this._registry.keys()]}},f=new k;Object.freeze(f);var p=class o{constructor(t){if(new.target===o)throw new Error("Cannot instantiate abstract class GUICommand.");this.guiAdapter=t}execute(){throw new Error("Execute method must be implemented.")}bind(){throw new Error("Bind method must be implemented.")}};var R=class extends p{constructor(t,e,i,n){super(),this.circuitService=t,this.circuitRenderer=e,this.elementRegistry=i,this.elementType=n,this.DEFAULT_X=400,this.DEFAULT_Y=300,this.ELEMENT_WIDTH=50,this.enableSnapping=!0,this.gridSpacing=10}execute(t=null){let e=this.elementRegistry.get(this.elementType);if(!e){console.error(`Factory function for element type "${this.elementType}" not found.`);return}(!t||!Array.isArray(t)||t.length!==2)&&(t=[{x:this.DEFAULT_X-this.ELEMENT_WIDTH/2,y:this.DEFAULT_Y},{x:this.DEFAULT_X+this.ELEMENT_WIDTH/2,y:this.DEFAULT_Y}]);let i=t;this.enableSnapping&&(i=t.map(r=>({x:Math.round(r.x/this.gridSpacing)*this.gridSpacing,y:Math.round(r.y/this.gridSpacing)*this.gridSpacing})));let n=i.map(r=>new h(r.x,r.y)),s=e(void 0,n,null,{});this.circuitService.addElement(s),this.circuitService.emit("update",{type:"addElement",element:s}),this.circuitRenderer&&this.circuitRenderer.render()}bind(){let t=document.getElementById(`add${this.elementType}`);if(!t){console.warn(`Button for adding ${this.elementType} not found.`);return}t.addEventListener("click",()=>this.execute()),console.log(`Bound AddElementCommand to add${this.elementType}`)}};var L=class extends p{constructor(t,e,i){super(),this.circuitService=t,this.elementRegistry=e,this.wireSplitService=i,this.wireElement=null,this.drawing=!1,this.direction=null,this.enableSnapping=!0,this.gridSpacing=10,this.THRESHOLD=2}start(t,e){let i=t,n=e;this.enableSnapping&&(i=Math.round(t/this.gridSpacing)*this.gridSpacing,n=Math.round(e/this.gridSpacing)*this.gridSpacing);let s=this.elementRegistry.get("Wire");if(!s){console.error("No wire factory registered.");return}this.wireElement=s(void 0,[new h(i,n),new h(i,n)],null,{}),this.circuitService.addElement(this.wireElement),this.drawing=!0,this.direction=null}move(t,e){if(!this.drawing||!this.wireElement)return;let i=t,n=e;this.enableSnapping&&(i=Math.round(t/this.gridSpacing)*this.gridSpacing,n=Math.round(e/this.gridSpacing)*this.gridSpacing);let[s,r]=this.wireElement.nodes,a=i-s.x,c=n-s.y,d=Math.abs(a),m=Math.abs(c);this.direction||(d-m>=this.THRESHOLD?this.direction="horizontal":m-d>=this.THRESHOLD&&(this.direction="vertical")),this.direction==="horizontal"?(r.x=s.x+a,r.y=s.y):this.direction==="vertical"?(r.x=s.x,r.y=s.y+c):(r.x=s.x+a,r.y=s.y+c),this.circuitService.emit("update",{type:"drawWire",wire:this.wireElement})}stop(){if(this.drawing=!1,this.direction=null,this.wireElement&&this.wireElement.nodes?.[1]){let t=this.wireElement.nodes[1];this.wireSplitService.trySplitAtNode(t)}this.wireElement=null}cancel(){this.wireElement&&this.circuitService.deleteElement(this.wireElement.id),this.drawing=!1,this.direction=null,this.wireElement=null}};var M=class extends p{constructor(t,e){super(),this.circuitService=t,this.wireSplitService=e,this.draggedElement=null,this.draggingNodeIndex=null,this.offset={x:0,y:0},this.nodeStartPos={x:0,y:0},this.dragAxis=null,this.enableSnapping=!0,this.gridSpacing=10,this.LOCK_THRESHOLD=2}start(t,e){for(let i of this.circuitService.getElements()){if(i.type==="wire"){let n=this.findClosestNodeIndex(i,t,e);if(n>=0){this.draggedElement=i,this.draggingNodeIndex=n,this.dragAxis=null;let s=i.nodes[n];this.offset.x=t-s.x,this.offset.y=e-s.y,this.nodeStartPos.x=s.x,this.nodeStartPos.y=s.y;return}}if(this.isInsideElement(t,e,i)){if(this.draggedElement=i,this.draggingNodeIndex=null,this.dragAxis=null,Array.isArray(i.nodes)&&i.nodes.length>0){let[n]=i.nodes;this.offset.x=t-n.x,this.offset.y=e-n.y}return}}}move(t,e){if(this.draggedElement&&!(!Array.isArray(this.draggedElement.nodes)||this.draggedElement.nodes.length===0)){if(this.draggingNodeIndex!==null){let i=this.draggedElement.nodes[this.draggingNodeIndex];for(let a of this.circuitService.getElements())if(a.id!==this.draggedElement.id&&a.nodes.includes(i)){let c=new h(i.x,i.y);this.draggedElement.nodes[this.draggingNodeIndex]=c;break}let n=this.draggedElement.nodes[this.draggingNodeIndex],s=t-this.offset.x,r=e-this.offset.y;if(this.enableSnapping&&(s=Math.round(s/this.gridSpacing)*this.gridSpacing,r=Math.round(r/this.gridSpacing)*this.gridSpacing),!this.dragAxis&&this.draggedElement.nodes.length===2){let a=this.draggingNodeIndex===0?1:0,c=this.draggedElement.nodes[a],d=c.x-n.x,m=c.y-n.y;this.dragAxis=Math.abs(d)>=Math.abs(m)?"horizontal":"vertical"}this.dragAxis==="horizontal"&&(r=n.y),this.dragAxis==="vertical"&&(s=n.x),n.x=s,n.y=r}else{let i=this.draggedElement.nodes[0],n=t-this.offset.x,s=e-this.offset.y;this.enableSnapping&&(n=Math.round(n/this.gridSpacing)*this.gridSpacing,s=Math.round(s/this.gridSpacing)*this.gridSpacing);let r=n-i.x,a=s-i.y;this.draggedElement.nodes=this.draggedElement.nodes.map(c=>new h(c.x+r,c.y+a))}this.circuitService.emit("update",{type:"dragElement",element:this.draggedElement})}}stop(){if(this.draggedElement?.type==="wire"&&Array.isArray(this.draggedElement.nodes)&&this.draggedElement.nodes.length===2){let[t,e]=this.draggedElement.nodes;if(this.draggingNodeIndex!==null){let i=this.draggedElement.nodes[this.draggingNodeIndex];if(this.wireSplitService.trySplitAtNode(i)){this._resetState();return}}if(this.draggingNodeIndex===null){for(let i of this.draggedElement.nodes)if(this.wireSplitService.trySplitAtNode(i)){this._resetState();return}}for(let i of this.circuitService.getElements())if(i.id!==this.draggedElement.id)for(let n of i.nodes){if(this.wireSplitService.splitWireAtPointIfTouching(this.draggedElement,n)){this._resetState();return}this.wireSplitService.trySplitAtNode(n)}}this._resetState()}_resetState(){this.draggedElement=null,this.draggingNodeIndex=null,this.dragAxis=null}findClosestNodeIndex(t,e,i){if(!Array.isArray(t.nodes))return-1;let n=10,s=-1,r=1/0;for(let a=0;a<t.nodes.length;a++){let c=t.nodes[a],d=Math.hypot(e-c.x,i-c.y);d<r&&(r=d,s=a)}return r<=n?s:-1}isInsideElement(t,e,i){if(!Array.isArray(i.nodes)||i.nodes.length<2)return!1;let[s,r]=i.nodes,a=Math.hypot(r.x-s.x,r.y-s.y);if(a===0)return Math.hypot(t-s.x,e-s.y)<=10;let c=Math.min(s.x,r.x)-10,d=Math.max(s.x,r.x)+10,m=Math.min(s.y,r.y)-10,g=Math.max(s.y,r.y)+10;return t<c||t>d||e<m||e>g?!1:Math.abs((r.y-s.y)*t-(r.x-s.x)*e+r.x*s.y-r.y*s.x)/a<=10}};var N=class{constructor(t,e){this.circuitService=t,this.elementRegistry=e}trySplitAtNode(t){for(let e of this.circuitService.getElements()){if(e.type!=="wire"||!Array.isArray(e.nodes)||e.nodes.length!==2)continue;let[i,n]=e.nodes;if(this._isOnSegment(t,i,n)&&!t.equals(i)&&!t.equals(n))return this._splitWire(e,t),!0}return!1}splitWireAtPointIfTouching(t,e){if(!Array.isArray(t.nodes)||t.nodes.length!==2)return!1;let[i,n]=t.nodes;return this._isOnSegment(e,i,n)&&!e.equals(i)&&!e.equals(n)?(this._splitWire(t,e),!0):!1}_isOnSegment(t,e,i){let n=(i.y-e.y)*(t.x-e.x)-(i.x-e.x)*(t.y-e.y);if(Math.abs(n)>1e-6)return!1;let s=(t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y),r=(i.x-e.x)**2+(i.y-e.y)**2;return s>0&&s<r}_splitWire(t,e){this.circuitService.deleteElement(t.id);let i=this.elementRegistry.get("Wire"),n=i(void 0,[t.nodes[0],e],null,{}),s=i(void 0,[e,t.nodes[1]],null,{});this.circuitService.addElement(n),this.circuitService.addElement(s)}};u.getTypes().length===0&&(u.register("Resistor",(o=w("R"),t,e=null,i={})=>{let n={resistance:1};return new T(o,t,e,new l(n))}),u.register("Wire",(o=w("W"),t,e=null,i={})=>new A(o,t,e,new l(i))));var P=new C;P.register("resistor",D);P.register("wire",I);async function O(o,t){let e=new N(o,u);f.getTypes().includes("addElement")||f.register("addElement",(i,n,s,r)=>new R(i,n,s,r)),f.getTypes().includes("drawWire")||f.register("drawWire",()=>new L(o,u,e)),f.getTypes().includes("dragElement")||f.register("dragElement",()=>new M(o,e))}var $=class extends v{constructor(t,e){super(),this.circuit=t,this.elementRegistry=e,this.on("commandExecuted",i=>{if(i.type==="addElement")try{let n=this.elementRegistry.get(i.elementType);if(!n)throw new Error(` No factory registered for element type: ${i.elementType}`);if(!Array.isArray(i.nodes))throw new Error(" Nodes must be provided as an array.");let s=i.nodes.map(c=>new h(c.x,c.y)),r=i.properties?new l(i.properties):new l,a=n(void 0,s,null,r);this.addElement(a)}catch(n){console.error(`Error creating element: ${n.message}`)}})}addElement(t){if(!t.id){let e=t.type.charAt(0).toUpperCase();t.id=w(e)}this.circuit.validateAddElement(t),this.circuit.elements.push(t),this.emit("update",{type:"addElement",element:t})}deleteElement(t){if(this.circuit.elements.find(i=>i.id===t)){this.circuit.elements=this.circuit.elements.filter(i=>i.id!==t);for(let[i,n]of this.circuit.connections.entries()){let s=n.filter(r=>r.id!==t);s.length===0?this.circuit.connections.delete(i):this.circuit.connections.set(i,s)}this.emit("update",{type:"deleteElement",elementId:t})}}connectElements(t,e){this.circuit.validateConnection(t,e),this.circuit.connections.set(t.id,[...this.circuit.connections.get(t.id)||[],e]),this.circuit.connections.set(e.id,[...this.circuit.connections.get(e.id)||[],t]),this.emit("update",{type:"connectElements",elements:[t,e]})}findConnections(t){let e=[];for(let[i,n]of this.circuit.connections.entries())n.includes(t)&&e.push(...n.filter(s=>s!==t));return e}getElements(){return[...this.circuit.elements]}exportState(){return JSON.stringify({elements:this.circuit.elements.map(t=>({id:t.id,type:t.type,nodes:t.nodes.map(e=>({x:e.x,y:e.y})),properties:{...t.properties.values}}))})}importState(t){function e(s){return s.charAt(0).toUpperCase()+s.slice(1)}let i=JSON.parse(t);this.circuit.elements=[];let n={};for(let s of i.elements){let r=this.elementRegistry.get(e(s.type));if(!r)throw new Error(`No factory for type ${s.type}`);let a=s.nodes.map(E=>new h(E.x,E.y)),c=s.properties??{},d=c&&typeof c.values=="object"&&c.values!==null?c.values:c,m=new l(d),g=r(s.id,a,s.label??null,m);n[g.id]=g,this.circuit.elements.push(g)}this.emit("update",{type:"restoredFromSnapshot"})}};var _=class{constructor(t,e,i){this.canvas=t,this.context=t.getContext("2d"),this.circuitService=e,this.rendererFactory=i,this.renderers=new Map(Array.from(i.registry.entries()).map(([n,s])=>[n,new s(this.context)])),this.draggedElement=null,this.offset={x:0,y:0},this.scale=1,this.offsetX=0,this.offsetY=0,this.isPanning=!1,this.startPanPosition={x:0,y:0},this.zoom=this.zoom.bind(this),this.startPan=this.startPan.bind(this),this.pan=this.pan.bind(this),this.stopPan=this.stopPan.bind(this),this.gridSpacing=10,this.gridColor="gray",this.gridLineWidth=.5,this.initEventListeners()}initEventListeners(){this.canvas.addEventListener("wheel",t=>this.zoom(t)),this.canvas.addEventListener("mousedown",t=>this.startPan(t)),this.canvas.addEventListener("mousemove",t=>this.pan(t)),this.canvas.addEventListener("mouseup",()=>this.stopPan()),this.canvas.addEventListener("mouseleave",()=>this.stopPan())}clearCanvas(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){this.clearCanvas(),this.context.save(),this.context.translate(this.offsetX,this.offsetY),this.context.scale(this.scale,this.scale),this.drawGrid(),this.circuitService.getElements().forEach(t=>{if(!this.renderers.has(t.type)){let i=this.rendererFactory.create(t.type,this.context);if(!i){console.warn(`No renderer found for element type: ${t.type}`);return}this.renderers.set(t.type,i)}this.renderers.get(t.type).renderElement(t)}),this.context.restore()}drawGrid(){let t=this.context,e=this.gridSpacing;t.strokeStyle=this.gridColor,t.lineWidth=this.gridLineWidth;let i=this.canvas.width/this.scale,n=this.canvas.height/this.scale,s=-this.offsetX/this.scale,r=-this.offsetY/this.scale,a=Math.floor(s/e)*e;t.beginPath();for(let d=a;d<=s+i;d+=e)t.moveTo(d,r),t.lineTo(d,r+n);let c=Math.floor(r/e)*e;for(let d=c;d<=r+n;d+=e)t.moveTo(s,d),t.lineTo(s+i,d);t.stroke()}zoom(t){t.preventDefault();let e=1.1,i=t.offsetX,n=t.offsetY,s=t.deltaY>0?1/e:e,r=this.scale*s;r<.5||r>3||(this.offsetX=i-(i-this.offsetX)*s,this.offsetY=n-(n-this.offsetY)*s,this.scale=r,this.render())}startPan(t){t.button===1&&(this.isPanning=!0,this.startPan.x=t.clientX-this.offsetX,this.startPan.y=t.clientY-this.offsetY)}pan(t){this.isPanning&&(this.offsetX=t.clientX-this.startPan.x,this.offsetY=t.clientY-this.startPan.y,this.render())}stopPan(){this.isPanning=!1}isInsideElement(t,e,i){let[n]=i.nodes,s=50;return t>=n.x&&t<=n.x+s&&e>=n.y&&e<=n.y+s}};var Y=class{constructor(){this.history=[],this.future=[]}executeCommand(t,e){let i=e.exportState();t.execute(e),this.history.push({snapshot:i,command:t}),this.future=[]}undo(t){if(this.history.length===0)return;let{snapshot:e,command:i}=this.history.pop(),n=t.exportState();t.importState(e),this.future.push({snapshot:n,command:i})}redo(t){if(this.future.length===0)return;let{snapshot:e,command:i}=this.future.pop(),n=t.exportState();t.importState(e),this.history.push({snapshot:n,command:i})}clear(){this.history=[],this.future=[]}};var H=class{constructor(t,e,i,n,s,r){this.controls=t,this.canvas=e,this.circuitService=i,this.elementRegistry=n,this.circuitRenderer=new _(e,i,s),this.guiCommandRegistry=r,this.commandHistory=new Y,this.dragCommand=null}initialize(){this.circuitRenderer.render(),this.bindUIControls(),this.setupCanvasInteractions(),this.circuitService.on("update",()=>this.circuitRenderer.render())}executeCommand(t,...e){let i=this.guiCommandRegistry.get(t,...e);i?this.commandHistory.executeCommand(i,...e):console.warn(`Command "${t}" not found.`)}bindUIControls(){this.elementRegistry.getTypes().forEach(t=>{let e=`add${t}`;console.log(`Searching for button: ${e}`);let i=this.controls.querySelector(`#${e}`);i?(console.log(`Found button: ${i.id}, binding addElement command for ${t}`),i.addEventListener("click",()=>{let n=this.guiCommandRegistry.get("addElement",this.circuitService,this.circuitRenderer,this.elementRegistry,t);n?(n.execute(),console.log(`Command 'addElement' executed for ${t}`)):console.warn(`Command 'addElement' not found for ${t}`)})):console.warn(`Button for adding ${t} not found`)})}executeCommand(t,...e){let i=this.guiCommandRegistry.get(t,...e);i?this.commandHistory.executeCommand(i,...e):console.warn(`Command "${t}" not found.`)}setupCanvasInteractions(){this.canvas.addEventListener("wheel",t=>{t.preventDefault(),this.circuitRenderer.zoom(t)}),this.canvas.addEventListener("mousedown",t=>{if(t.button===1){this.canvas.style.cursor="grabbing",this.panStartX=t.clientX-this.circuitRenderer.offsetX,this.panStartY=t.clientY-this.circuitRenderer.offsetY;return}if(t.button===0){let{offsetX:e,offsetY:i}=this.getTransformedMousePosition(t);this.findElementAt(e,i)?(this.activeCommand=this.guiCommandRegistry.get("dragElement",this.circuitService),this.activeCommand&&this.activeCommand.start(e,i)):(this.activeCommand=this.guiCommandRegistry.get("drawWire",this.circuitService,this.elementRegistry),this.activeCommand&&this.activeCommand.start(e,i)),this.hasDragged=!1,this.mouseDownPos={x:e,y:i}}}),this.canvas.addEventListener("mousemove",t=>{if(this.activeCommand){let{offsetX:e,offsetY:i}=this.getTransformedMousePosition(t),n=e-this.mouseDownPos.x,s=i-this.mouseDownPos.y;Math.sqrt(n*n+s*s)>2&&(this.hasDragged=!0),this.activeCommand.move(e,i)}}),this.canvas.addEventListener("mouseup",t=>{if(t.button===1){this.canvas.style.cursor="default";return}this.activeCommand&&(!this.hasDragged&&this.activeCommand.cancel&&this.activeCommand.cancel(),this.activeCommand.stop(),this.activeCommand=null)})}getTransformedMousePosition(t){let e=this.canvas.getBoundingClientRect();return{offsetX:(t.clientX-e.left-this.circuitRenderer.offsetX)/this.circuitRenderer.scale,offsetY:(t.clientY-e.top-this.circuitRenderer.offsetY)/this.circuitRenderer.scale}}findElementAt(t,e){for(let i of this.circuitService.getElements())if(this.isInsideElement(t,e,i))return i;return null}isInsideElement(t,e,i){if(i.nodes.length<2)return!1;let n=10,[s,r]=i.nodes,a=r.x-s.x,c=r.y-s.y,d=Math.hypot(a,c);if(d<1e-6)return Math.hypot(t-s.x,e-s.y)<=n;if(Math.abs(c*t-a*e+r.x*s.y-r.y*s.x)/d>n)return!1;let g=Math.min(s.x,r.x)-n,E=Math.max(s.x,r.x)+n,V=Math.min(s.y,r.y)-n,F=Math.max(s.y,r.y)+n;return!(t<g||t>E||e<V||e>F)}};function K({model:o,el:t}){let e=document.createElement("button");e.id="addResistor",e.textContent="Add Resistor";let i=document.createElement("button");i.id="addWire",i.textContent="Add Wire";let n=document.createElement("button");n.id="export",n.textContent="Export circuit";let s=document.createElement("canvas");s.id="circuitCanvas",s.width=800,s.height=600,s.style.border="1px solid black";let r=document.createElement("div");r.className="controls",r.appendChild(e),r.appendChild(i),r.appendChild(n),t.appendChild(r),t.appendChild(s);let a=new S,c=new $(a,u),d=new H(r,s,c,u,P,f);O(c,d.circuitRenderer).then(()=>{d.initialize()}),o.set("exportTrigger",0),n.addEventListener("click",()=>{o.set("circuitElements",c.getElements()),o.set("exportTrigger",o.get("exportTrigger")+1),o.save_changes()})}var be={render:K};export{be as default};
