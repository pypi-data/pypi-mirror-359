name: Publish Environment

permissions:
  id-token: write
  contents: read
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      folder:
        description: 'The folder to build'
        required: true
        type: string
      environment:
        description: "The environment to use"
        required: true
        type: string
        default: "staging"

jobs:
  publish-experiment:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    env:
      X_API_KEY: ""
      FOLDER: ${{ github.event.inputs.folder }}
      BASE_URL: ""
      SELECTED_ACCOUNT: ""
      BASE_URL_STAGING: "http://qcog-api-staging-lb-690850646.us-east-2.elb.amazonaws.com/api/v1"
      BASE_URL_PROD: "https://api.qcog.ai/api/v1"
      BASE_URL_STAGING_ACCOUNT: "905418339935"
      BASE_URL_PROD_ACCOUNT: "211125665565"
      UV_INDEX_GEMFURY_PASSWORD: ${{ secrets.GEMFURY_READ_TOKEN }}
      UV_INDEX_GEMFURY_USERNAME: qognitive

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Python Setup
        uses: actions/setup-python@v3
        with:
          python-version: 3.12

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r scripts/publish_environment.requirements.txt

      - name: Set X_API_KEY
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "prod" ]]; then
            echo "X_API_KEY=${{ secrets.PROD_X_API_KEY }}" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.environment }}" == "staging" ]]; then
            echo "X_API_KEY=${{ secrets.STAGING_X_API_KEY }}" >> $GITHUB_ENV
          else
            echo "Invalid environment: ${GITHUB_EVENT_INPUTS_ENVIRONMENT}"
            exit 1
          fi

      - name: Set BASE_URL
        id: set-base-url
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "prod" ]]; then
            echo "BASE_URL=${{ env.BASE_URL_PROD }}" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.environment }}" == "staging" ]]; then
            echo "BASE_URL=${{ env.BASE_URL_STAGING }}" >> $GITHUB_ENV
          else
            echo "Invalid environment: ${GITHUB_EVENT_INPUTS_ENVIRONMENT}"
            exit 1
          fi

      - name: Set SELECTED_ACCOUNT
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "prod" ]]; then
            echo "SELECTED_ACCOUNT=${{ env.BASE_URL_PROD_ACCOUNT }}" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.environment }}" == "staging" ]]; then
            echo "SELECTED_ACCOUNT=${{ env.BASE_URL_STAGING_ACCOUNT }}" >> $GITHUB_ENV
          else
            echo "Invalid environment: ${GITHUB_EVENT_INPUTS_ENVIRONMENT}"
            exit 1
          fi

      - name: Perform AWS Login
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.SELECTED_ACCOUNT }}:role/${{ github.event.inputs.environment }}-qognitive-hone-packages-github-readandwrite-role
          aws-region: us-east-2
          audience: sts.amazonaws.com

      - name: Upload Experiment
        run: |
          echo "BASE_URL=${{ env.BASE_URL }}"
          echo "FOLDER=${{ env.FOLDER }}"
          python scripts/publish_environment.py \
            --base-url ${{ env.BASE_URL }} \
            --folder-path ${{ env.FOLDER }} \
            --environment ${{ github.event.inputs.environment }} \

