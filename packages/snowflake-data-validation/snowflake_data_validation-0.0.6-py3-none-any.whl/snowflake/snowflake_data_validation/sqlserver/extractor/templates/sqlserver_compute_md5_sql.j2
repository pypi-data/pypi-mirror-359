CREATE TABLE #ROW_CONCATENATED_{{ chunk_id }} (
    {% for index_column in index_column_collection %}
        "{{ index_column.name }}_IDX" {{ index_column.data_type }},
    {% endfor %}
    ROW_CONCAT_VALUES VARCHAR(MAX)
);

INSERT INTO #ROW_CONCATENATED_{{ chunk_id }}
SELECT
    {% for index_column in index_column_collection %}
        "{{ index_column.name }}_IDX",
    {% endfor %}
    {% if column_collection|length > 1 %}
        CONCAT({{ column_names_separate_by_comma }})
    {% else %}
        {{ column_names_separate_by_comma }}
    {% endif %} FROM
    (SELECT
         {% for index_column in index_column_collection %}
            "{{ index_column.name }}" AS "{{ index_column.name }}_IDX",
         {% endfor %}
         {% for column in column_collection %}
            {% if column.nullable %}
                coalesce({{ datatypes_normalization_renderer_templates[column.name] }}, '') AS "{{ column.name }}"{% if not loop.last %},{% endif %}
            {% else %}
                {{ datatypes_normalization_renderer_templates[column.name] }} AS "{{ column.name }}"{% if not loop.last %},{% endif %}
            {% endif %}
         {% endfor %}
     FROM {{ fully_qualified_name }}
     {% if has_where_clause %} WHERE {{ where_clause }} {% endif %}
    ) AS RW;

CREATE TABLE #ROW_MD5_{{ chunk_id }}(
    {% for index_column in index_column_collection %}
        "{{ index_column.name }}" {{ index_column.data_type }},
    {% endfor %}
    ROW_MD5 VARCHAR(32)
);

INSERT INTO #ROW_MD5_{{ chunk_id }}
SELECT
    {% for index_column in index_column_collection %}
        "{{ index_column.name }}_IDX" {{ index_column.data_type }},
    {% endfor %}
    CONVERT(VARCHAR(32), HASHBYTES('MD5', ROW_CONCAT_VALUES), 2)
FROM #ROW_CONCATENATED_{{ chunk_id }};

INSERT INTO #CHUNKS_MD5_{{ normalized_fully_qualified_name }}
SELECT
    '{{ chunk_id }}',
    CONVERT(VARCHAR(32), HASHBYTES('MD5', STRING_AGG(ROW_MD5, '')), 2)
FROM #ROW_MD5_{{ chunk_id }};
