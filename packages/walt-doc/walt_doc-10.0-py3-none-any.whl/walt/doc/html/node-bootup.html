<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Node bootup procedure &mdash; WalT 10.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
    <link rel="shortcut icon" href="_static/logo-walt.png"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=864e5427"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Boot modes: network boot and hybrid boot" href="boot-modes.html" />
    <link rel="prev" title="How to setup a WalT VPN SSH entrypoint" href="vpn-ssh-entrypoint.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: gray" >

          
          
          <a href="index.html" class="icon icon-home">
            WalT
              <img src="_static/logo-walt.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Admin / Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="admin.html">Admin documentation summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="server-install.html">WalT server installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="server-upgrade.html">WalT server upgrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="server-network-config.html">WalT server-side network configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="node-install.html">WalT node installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="switch-install.html">Switch installation in WalT network</a></li>
<li class="toctree-l1"><a class="reference internal" href="client-install.html">WalT client software installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">WalT network structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="registries.html">WalT image registries</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting tips</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">User Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="shells.html">Shell usage notes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using nodes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="node-ownership.html">Node ownership</a></li>
<li class="toctree-l1"><a class="reference internal" href="node-reboot.html">Rebooting WalT nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="node-config.html">Updating configuration settings about nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="node-console.html">Connecting to a node’s serial console</a></li>
<li class="toctree-l1"><a class="reference internal" href="node-cp.html">Transfering files to or from a node</a></li>
<li class="toctree-l1"><a class="reference internal" href="node-save.html">Saving the current OS state of a node</a></li>
<li class="toctree-l1"><a class="reference internal" href="node-expose.html">Exposing the TCP port of a node</a></li>
<li class="toctree-l1"><a class="reference internal" href="node-netsetup.html">Changing network mode for a WalT node</a></li>
<li class="toctree-l1"><a class="reference internal" href="vnode-networks.html">Configuring secondary networks on virtual nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="vnode-disks.html">Configuring disks on virtual nodes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using images</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="image-build.html">Building a WalT image from a Dockerfile</a></li>
<li class="toctree-l1"><a class="reference internal" href="image-cp.html">Transfering files to or from a walt image</a></li>
<li class="toctree-l1"><a class="reference internal" href="image-spec-file.html">Writting image spec files</a></li>
<li class="toctree-l1"><a class="reference internal" href="image-from-scratch.html">Creating a WalT image from scratch</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using devices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="device-sets.html">Device and node sets: use several devices at once</a></li>
<li class="toctree-l1"><a class="reference internal" href="device-config.html">Updating configuration settings about devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="device-port-config.html">Viewing and updating switch ports configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="device-expose.html">Exposing the TCP port of a device</a></li>
<li class="toctree-l1"><a class="reference internal" href="device-netsetup.html">Changing network mode of a WalT node or device</a></li>
<li class="toctree-l1"><a class="reference internal" href="unmanaged-devices.html">Managing devices which do not implement WalT network booting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Recording logs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="logging.html">How to use WalT logging system</a></li>
<li class="toctree-l1"><a class="reference internal" href="log-show.html">How to query &amp; display experiment logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="log-wait.html">Synchronizing a script based on expected logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="log-checkpoint.html">Log checkpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="log-history.html">Displaying past logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="log-realtime.html">Displaying logs in realtime</a></li>
<li class="toctree-l1"><a class="reference internal" href="log-issuers.html">Selecting log issuers</a></li>
<li class="toctree-l1"><a class="reference internal" href="log-format.html">Adapting log display format</a></li>
<li class="toctree-l1"><a class="reference internal" href="log-echo.html"><code class="docutils literal notranslate"><span class="pre">walt-log-echo</span></code> logging tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="log-cat.html"><code class="docutils literal notranslate"><span class="pre">walt-log-cat</span></code> logging tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="log-tee.html"><code class="docutils literal notranslate"><span class="pre">walt-log-tee</span></code> logging tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="log-monitor.html"><code class="docutils literal notranslate"><span class="pre">walt-log-monitor</span></code> logging tool</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Scripting</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="scripting.html">Scripting WalT experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="scripting-nodes.html">scripting API: node management</a></li>
<li class="toctree-l1"><a class="reference internal" href="scripting-images.html">scripting API: image management</a></li>
<li class="toctree-l1"><a class="reference internal" href="scripting-logs.html">scripting API: logs management</a></li>
<li class="toctree-l1"><a class="reference internal" href="scripting-tools.html">scripting API: miscellaneous tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Web services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="web-server.html">Web server</a></li>
<li class="toctree-l1"><a class="reference internal" href="web-api.html">Using the web API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">VPN / distant nodes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="vpn.html">How to use WalT built-in VPN and distant nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="vpn-security.html">WalT VPN Security notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="vpn-http-entrypoint.html">How to setup a WalT VPN HTTP entrypoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="vpn-ssh-entrypoint.html">How to setup a WalT VPN SSH entrypoint</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How it works</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Node bootup procedure</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#reminder-about-walt-image-structure">Reminder about walt image structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bootup-steps">Bootup steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="boot-modes.html">Boot modes: network boot and hybrid boot</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="developer.html">Developer documentation summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-walt-python-packages.html">Repository: walt-python-packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-client.html">Repository: walt-python-packages; walt-client code.</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-server.html">Repository: walt-python-packages; walt-server code.</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-server-db.html">WalT server database</a></li>
<li class="toctree-l1"><a class="reference internal" href="trackexec.html">Repository: walt-python-packages; trackexec tooling.</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="design-notes.html">Scope and design notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="optional-features.html">Optional features of a WalT platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="shell-completion.html">Shell completion setup (bash and zsh)</a></li>
<li class="toctree-l1"><a class="reference internal" href="compatibility.html">Compatibility notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="new-node-support.html">Adding support for a new node in WalT</a></li>
<li class="toctree-l1"><a class="reference internal" href="packaging.html">Packaging notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="rpi-serial.html">Using the serial port of a Raspberry Pi</a></li>
<li class="toctree-l1"><a class="reference internal" href="g5k.html">Deploying WalT on Grid’5000</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: gray" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">WalT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Node bootup procedure</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="node-bootup-procedure">
<h1>Node bootup procedure<a class="headerlink" href="#node-bootup-procedure" title="Link to this heading"></a></h1>
<section id="reminder-about-walt-image-structure">
<h2>Reminder about walt image structure<a class="headerlink" href="#reminder-about-walt-image-structure" title="Link to this heading"></a></h2>
<p>For details about walt image structure, checkout
<a class="reference internal" href="image-from-scratch.html"><span class="doc">walt help show image-from-scratch</span></a>.</p>
<p>The following summarizes the important points regarding network boot
handling.</p>
<p>In order to support several node models in WalT, we have to know which
node model(s) a given image supports. For example, some images may
support only <code class="docutils literal notranslate"><span class="pre">rpi-2-b</span></code> and <code class="docutils literal notranslate"><span class="pre">rpi-3-b</span></code> boards. Thus, every walt image
must provide a docker label that indicates which models this image can
handle.</p>
<p>The image must also provide a directory <code class="docutils literal notranslate"><span class="pre">/boot/&lt;model&gt;</span></code> for each
model. This directory contains the boot files needed (see bootup steps
below).</p>
</section>
<section id="bootup-steps">
<h2>Bootup steps<a class="headerlink" href="#bootup-steps" title="Link to this heading"></a></h2>
<p>The following applies to a raspberry pi node, in the default boot-mode
(i.e., network boot mode).</p>
<p>PC nodes boot very much the same, except that:</p>
<ul class="simple">
<li><p>the bootloader is iPXE instead of u-Boot</p></li>
<li><p>the SD card is usually replaced by a USB device</p></li>
</ul>
<p>For more information about alternate boot modes, see
<a class="reference internal" href="boot-modes.html"><span class="doc">walt help show boot-modes</span></a>.</p>
<p>Here are the bootup steps:</p>
<ol class="arabic simple">
<li><p>The board is powered on and starts its firmware</p></li>
<li><p>The firmware starts u-boot as a 2nd stage bootloader stored on the
SD card</p></li>
<li><p>u-boot starts the 1st stage script stored on the SD card</p></li>
<li><p>if needed, the script analyses environment variables (cpu model,
etc.) in order to detect the exact model (e.g. <code class="docutils literal notranslate"><span class="pre">rpi-3-b</span></code>).</p></li>
<li><p>u-boot runs its DHCP client procedure in order to get its IP address
and the address of the TFTP server (i.e. the walt server), or
reboots if it fails. The model of node is passed to the DHCP server
by using the VCI field (vendor class identifier) or UCI (user class
identifier) of the DHCP request. The VCI is set on u-boot side by a
line such as <code class="docutils literal notranslate"><span class="pre">setenv</span> <span class="pre">bootp_vci</span> <span class="pre">walt.node.&lt;model&gt;</span></code>.</p></li>
<li><p>The DHCP server (on the walt server) has a hook allowing to detect a
lease has been delivered. When this happens, a tool called
<code class="docutils literal notranslate"><span class="pre">walt-dhcp-event</span></code> is run (with mac, ip, vci and uci as
parameters). This allows to send a node registration request to
<code class="docutils literal notranslate"><span class="pre">walt-server-daemon</span></code>.</p></li>
<li><p>If the node is new:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">walt-server-daemon</span></code> ensures the default image for this model
of node is downloaded. (This step may last a long time if it
involves downloading an image from the docker hub.)</p></li>
<li><p>If needed, it mounts the image at
<code class="docutils literal notranslate"><span class="pre">[image_root]</span> <span class="pre">=</span> <span class="pre">/var/lib/walt/images/&lt;image_id&gt;/fs</span></code> and adds a
few walt-specific files (e.g. <code class="docutils literal notranslate"><span class="pre">/bin/walt-init</span></code> and associated
boot scripts, public key authentification files for passwordless
ssh connection on node, etc.)</p></li>
<li><p>It creates several symlinks (see note 1 for details):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/var/lib/walt/nodes/{ip_address}/fs</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">[image_root]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/var/lib/walt/nodes/{ip_address}/tftp</span></code> -&gt;
<code class="docutils literal notranslate"><span class="pre">[image_root]/boot/&lt;model&gt;</span></code></p></li>
</ul>
</li>
</ol>
</li>
<li><p>u-boot downloads and executes the second stage script at
<code class="docutils literal notranslate"><span class="pre">tftp:/start.uboot</span></code>. The tftp server actually remaps this to
<code class="docutils literal notranslate"><span class="pre">/var/lib/walt/nodes/{ip_address}/tftp/start.uboot</span></code> thanks to a
mapping rule. And this actually targets
<code class="docutils literal notranslate"><span class="pre">[image_root]/boot/&lt;model&gt;/start.uboot</span></code> thanks to the 2nd symlink
above. If the TFTP request fails (supposedly the walt image is not
ready yet), the node reboots. Having such a second boot stage script
stored on the image allows to update the boot procedure for specific
needs (adding a kernel parameter, etc). The rest of the procedure is
handled by this script. We list below the steps that are performed
by our default raspberry pi image, for instance.</p></li>
<li><p>u-boot tries to load <code class="docutils literal notranslate"><span class="pre">tftp:/kernel</span></code> (mapped to
<code class="docutils literal notranslate"><span class="pre">[image_root]/boot/&lt;model&gt;/kernel</span></code>), or reboot if it fails;</p></li>
<li><p>u-boot tries to load <code class="docutils literal notranslate"><span class="pre">tftp:/dtb</span></code> (mapped to
<code class="docutils literal notranslate"><span class="pre">[image_root]/boot/&lt;model&gt;/dtb</span></code>), or reboot if it fails;</p></li>
<li><p>u-boot starts the kernel, with the following kernel options (and
more)
<code class="docutils literal notranslate"><span class="pre">init=/bin/walt-init</span> <span class="pre">root=/dev/nfs</span> <span class="pre">nfsroot=&lt;server_ip&gt;:/var/lib/walt/nodes/{ip_address}/fs,nfsvers=3</span></code></p></li>
<li><p>the kernel starts, mounts the NFS share and then calls
<code class="docutils literal notranslate"><span class="pre">/bin/walt-init</span></code></p></li>
<li><p>walt-init starts the NFS watchdog process (to periodically check
that the NFS share is accessible and reboot otherwise)</p></li>
<li><p>walt-init starts the network service process (to perform soft-reboot
requests sent by the server)</p></li>
<li><p>walt-init starts the bootup notification process. This process waits
for port localhost:22 to be opened (since all walt images must
provide a ssh server process) and then sends a bootup notification
to the server.</p></li>
<li><p>walt-init runs <code class="docutils literal notranslate"><span class="pre">walt-clock-sync</span></code> to ensure an initial clock
synchronization with the server (for more precise clock
synchronization, the image should provide a PTP daemon)</p></li>
<li><p>walt-init mounts a union of the NFS root and a virtual filesystem in
RAM (see note 2)</p></li>
<li><p>if the OS image supports it, walt-init mounts a remote NBD device
(Network Block Device) to be be able to swap memory on the server in
selected scenarios (see note 2)</p></li>
<li><p>walt-init calls <code class="docutils literal notranslate"><span class="pre">/sbin/init</span></code> (the regular OS init system, such as
systemd) in a chroot on top of the union</p></li>
<li><p>the walt image OS starts up</p></li>
</ol>
<p>Notes and details:</p>
<ol class="arabic simple">
<li><p>Actually, in directory <code class="docutils literal notranslate"><span class="pre">/var/lib/walt/nodes</span></code>, several entries are
created for each node, all pointing to the same structure described
above. The <code class="docutils literal notranslate"><span class="pre">{mac_address}</span></code> is also present in two forms, together
with the <code class="docutils literal notranslate"><span class="pre">{ip_address}</span></code> entry. This allows to deal with the
limitations of the bootloaders and TFTP server remapping syntax.</p></li>
<li><p>This union of the NFS root and a virtual filesystem in RAM is a very
important feature, see
<a class="reference internal" href="boot-modes.html"><span class="doc">walt help show boot-modes</span></a> for more info.</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="vpn-ssh-entrypoint.html" class="btn btn-neutral float-left" title="How to setup a WalT VPN SSH entrypoint" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="boot-modes.html" class="btn btn-neutral float-right" title="Boot modes: network boot and hybrid boot" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2012-2023, Members of the WALT project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>